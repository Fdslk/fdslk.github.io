
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>ops_vanish | 🪳的Daily Blog WebSite</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="">
    <meta name="description" content="Varnish using for new fresh
What is varnish

Varnish is a http  cache tool for accelerating http request response.
The configuration language of varnish is named as VCL, which can handle the incoming requests
decide what content you want to server
from where you want to get the content
how the request or response...">
    
        <link rel="icon" href="/favicon.ico">
    
    
        
            <link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
        
            <link rel="stylesheet" href="/css/stage.css">
        
            <link rel="stylesheet" href="/css/avatar-bg.css">
        
    
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
<header id="header">
    <div class="menu">
        <i class="fa fa-bars"></i>
    </div>
    <div class="header-main">
        <h1><a href="/">🪳的Daily Blog WebSite</a></h1>
    </div>
    <div id="nav">
        <div class="nav-img" id="nav-img"></div>
        <div class="sentences">
            云里写诗，泥里生活，岁月里洒脱。
        </div>
    </div>
</header>

<div id="content-outer">
    <div id="content-inner">
        <div class="clearfix">
    <article id="post">
        <h1>ops_vanish</h1>
        <div class="create">
            <span>Created</span>
            
                <time datetime="2023-03-05T07:04:12.000Z">
                    2023-03-05
                </time>
            
            <ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/tech/">tech</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/tech/ops/">ops</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/tech/ops/cache/">cache</a></li></ul></li></ul></li></ul>
        </div>
        <h1 id="Varnish-using-for-new-fresh"><a href="#Varnish-using-for-new-fresh" class="headerlink" title="Varnish using for new fresh"></a>Varnish using for new fresh</h1><ul>
<li><p><strong>What</strong> is varnish</p>
<ul>
<li>Varnish is a http  cache tool for accelerating http request response.</li>
<li>The configuration language of varnish is named as <strong>VCL</strong>, which can handle the incoming requests<ul>
<li>decide what content you want to server</li>
<li>from where you want to get the content</li>
<li>how the request or response should be altered</li>
<li>beef-sandwich<br><img src="https://user-images.githubusercontent.com/6279298/165006846-8501c3a2-e6ea-43c6-81c1-88416128468c.png" alt="varnish in network"></li>
<li>How does it work<ul>
<li>based on VCL program, it can ‘Which backend has this content, how long time can we cache it, is it accessible for this request, should it be redirected elsewhere and so on’.</li>
<li><strong>VCL</strong> can be compiled into C-program which is complied into a shared lib. <strong>This will happen to varnish loads VCL program.</strong></li>
</ul>
</li>
</ul>
</li>
<li>core features<ul>
<li>caching, using Cache-Control HTTP header</li>
<li>Content Composition</li>
<li>support many different OS platforms</li>
<li>full control of every request</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>How</strong> to install varnish</p>
<ul>
<li><code>brew install varnish</code></li>
<li><code>sudo mv  /usr/local/opt/varnish/sbin/varnishd /usr/local/bin/</code></li>
<li>then varnishd can be executed directly</li>
</ul>
</li>
<li><p><strong>How</strong> to use varnish</p>
<ul>
<li><p>in local</p>
<ul>
<li>add default.vcl file</li>
<li>run the following cmd <code>varnishd -a :6081,HTTP -f default.vcl -F</code><ul>
<li>-a listening port</li>
<li>-f configuration file location</li>
<li>-F run varnish in the front</li>
</ul>
</li>
<li>call the <code>127.0.0.1/api/public</code> for testing</li>
</ul>
</li>
<li><p>by docker</p>
<ul>
<li><p>use docker cmd directly</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm -v $(PWD)/default-docker.vcl:/etc/varnish/default.vcl:ro \  </span><br><span class="line">    --tmpfs /var/lib/varnish/varnishd:exec \</span><br><span class="line">    --name my-varnish-container \</span><br><span class="line">    -p 8081:80 \</span><br><span class="line">    -e VARNISH_SIZE=2G \</span><br><span class="line">    varnish</span><br></pre></td></tr></table></figure>

<ul>
<li>varnish proxy the local machine service, the host of vcl should be set as <strong>“docker.mac.for.localhost”</strong>.</li>
<li>tips:<ul>
<li>varnish port in docker is <strong>80</strong></li>
</ul>
</li>
</ul>
</li>
<li><p>use docker file</p>
<ul>
<li><p>create a docker file</p>
</li>
<li><p>mount the vcl file into your custom image</p>
</li>
<li><p>run your custom image</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --tmpfs /var/lib/varnish/varnishd:exec -p <span class="number">8081</span>:<span class="number">80</span> local-varnish</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>docker-compose</p>
</li>
</ul>
</li>
<li><p>in local k8s</p>
<ul>
<li>create k8s configMap for mounting default.vcl</li>
</ul>
<p><code>kubectl create configmap varnish-vcl --from-file=default.vcl</code></p>
<ul>
<li>deploy</li>
</ul>
<p><code>kubectl apply -f deployment/deployment.yaml</code></p>
<ul>
<li>call api</li>
</ul>
<p><code>http://localhost:6081/api/public</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;All good. You DO NOT need to be authenticated to call /api/public.&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>validate</p>
<ul>
<li><p>step1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it varnish-proxy-5b4844596c-22hsl -c varnish-for-be -- sh</span><br></pre></td></tr></table></figure>
</li>
<li><p>step2<br><code>run varnishlog</code><br><img src="https://user-images.githubusercontent.com/6279298/165884032-802f7273-aa55-4aee-8109-eff0742a445d.png" alt="request detail"></p>
</li>
</ul>
</li>
<li><p>issue:</p>
<ul>
<li>if not define the <strong>Type</strong> in service yaml, it will use the default value <strong>ClusterIP</strong></li>
<li>Solution: add <strong>type: NodePort</strong> under spec section</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/Fdslk/ops/tree/main/varnish">varnish</a></p>

        <div>
            
        </div>
        <div class="bottom-line"></div>
        
    <nav id="article-nav">
        
            <a href="/tech/ops/log/2023/03/05/ops-log-management/" id="article-nav-newer" class="article-nav-link-wrap">
        <span class="article-nav-title">
            
                ops_log_management
            
        </span>
                <strong class="article-nav-caption">&gt;</strong>
            </a>
        
        
            <a href="/tech/ops/k8s/secret/2023/03/05/ops-k8s-secret/" id="article-nav-older" class="article-nav-link-wrap">
                <strong class="article-nav-caption">&lt;</strong>
                <span class="article-nav-title">
                    
                        ops_k8s_secret
                </span>
                
            </a>
        
    </nav>


        
    </article>
    <div id="toc">
        
            <h2>Table of Contents</h2>
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Varnish-using-for-new-fresh"><span class="toc-number">1.</span> <span class="toc-text">Varnish using for new fresh</span></a></li></ol>
        
    </div>
</div>

    </div>
</div>
<footer id="footer">
    <div id="copyright">&copy; Zengqiang Fang  2023</div>
    <div id="theme">
        Powered by <a target="_blank" rel="noopener" href="http://hexo.io">Hexo</a>. Theme by <a target="_blank" rel="noopener" href="https://github.com/markyong/hexo-theme-stage">Stage</a>
    </div>
</footer>
<script src="/lib/js/waterrippleeffect.min.js"></script>
<script src="/js/header-bg.main.js"></script>

    <script src="/lib/js/smooth-scroll.min.js"></script>
    <script src="/js/toc.main.js"></script>

</body>
</html>
