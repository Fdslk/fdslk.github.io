<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>🪳的Daily Blog WebSite</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta property="og:type" content="website">
<meta property="og:title" content="🪳的Daily Blog WebSite">
<meta property="og:url" content="http://fdslk.github.io/index.html">
<meta property="og:site_name" content="🪳的Daily Blog WebSite">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Zengqiang Fang">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="🪳的Daily Blog WebSite" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">🪳的Daily Blog WebSite</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://fdslk.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-dotnet-core-related" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/tech/dotnet-core/2023/03/05/dotnet-core-related/" class="article-date">
  <time class="dt-published" datetime="2023-03-05T07:17:13.000Z" itemprop="datePublished">2023-03-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/tech/">tech</a>►<a class="article-category-link" href="/categories/tech/dotnet-core/">dotnet-core</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/tech/dotnet-core/2023/03/05/dotnet-core-related/">dotnet_core_related</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="dotnet-core-practices"><a href="#dotnet-core-practices" class="headerlink" title="dotnet core practices"></a>dotnet core practices</h1><ul>
<li>设计模式<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Fdslk/myCoreApp/tree/master/AbstractTest">抽象模式</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Fdslk/myCoreApp/tree/master/SingletonPattern">单例模式</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/Fdslk/myCoreApp/tree/master/DILifeTime">global异常捕获</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Fdslk/myCoreApp/tree/master/Docker-Compose-Nginx-NetCore-master">docker-compose启动dotcore-webapplication+nginx</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Fdslk/myCoreApp/tree/master/EventTest">event handler</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Fdslk/myCoreApp/tree/master/FilterApiImplement">filter</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Fdslk/myCoreApp/tree/master/FunctionalPractice">dotnet functional</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Fdslk/myCoreApp/tree/master/JWTAuthentication">jwt token</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Fdslk/myCoreApp/tree/master/ReflectionTest">refeclt的应用</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Fdslk/myCoreApp/tree/master/SOLIDTEST">SOLID</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Fdslk/myCoreApp/tree/master/coverage">如何使用coveragereport生成测试报告</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Fdslk/myCoreApp/blob/master/customSerialization">如何使用Newtonsoft.Json自定义resovler</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Fdslk/myCoreApp/tree/master/databaseConnector">使用EntityFrameworkCore连接数据库</a><ul>
<li>如何使用filter现实response的global管理</li>
<li>如何 DbContext连接数据库</li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/Fdslk/myCoreApp/tree/master/loggingTest">如何在pipeline中添加logger</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Fdslk/myCoreApp/tree/master/mysolution">dotnetcore基础语法</a><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Fdslk/myCoreApp/tree/master/mysolution/APP.TEST">List</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Fdslk/myCoreApp/tree/master/mysolution/AttributePrc">Attribute</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Fdslk/myCoreApp/tree/master/mysolution/EventHandle">event delegate</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Fdslk/myCoreApp/blob/master/unit-testing-using-dotnet-test/PrimeService.Tests/MockOperationTest.cs">mock test</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/Fdslk/myCoreApp/tree/master/unit-testing-using-dotnet-test/PrimeService">automaaper</a></li>
</ul>
</li>
<li><a target="_blank" rel="noopener" href="https://github.com/Fdslk/myCoreApp/tree/master/uploadDemo">upload file</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fdslk.github.io/tech/dotnet-core/2023/03/05/dotnet-core-related/" data-id="clev2anaw0008j8hsbmupg5qs" data-title="dotnet_core_related" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-gatling-load-test" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/tech/test/gatling/2023/03/05/gatling-load-test/" class="article-date">
  <time class="dt-published" datetime="2023-03-05T07:13:00.000Z" itemprop="datePublished">2023-03-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/tech/">tech</a>►<a class="article-category-link" href="/categories/tech/test/">test</a>►<a class="article-category-link" href="/categories/tech/test/gatling/">gatling</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/tech/test/gatling/2023/03/05/gatling-load-test/">gatling_load_test</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="GatlingRepo"><a href="#GatlingRepo" class="headerlink" title="GatlingRepo"></a>GatlingRepo</h1><pre><code>load test by Gatling in this repo, you will know how to use gatling to do load test
</code></pre>
<ul>
<li>preparation<ul>
<li><p>download gatling</p>
</li>
<li><p>unzip your gatling zip file</p>
</li>
<li><p>use the cmd<br><code>/Users/zengqiangfang/Downloads/software/gatling-charts-highcharts-bundle-3.7.5/bin</code></p>
</li>
<li><p>execute .&#x2F;recorder.sh (in mac) will open the following GUI<br><img src="https://user-images.githubusercontent.com/6279298/155526456-aa122499-b148-4f66-ab8b-56a6be3f898b.jpg" alt="gatling recorder GUI"></p>
</li>
<li><p>then go to a website <a target="_blank" rel="noopener" href="https://computer-database.gatling.io/">computer-database</a>.</p>
<ul>
<li><p>open the developer model of your browser</p>
</li>
<li><p>check the presave-log operation</p>
</li>
<li><p>doing the following operations</p>
<ul>
<li>reload home page</li>
<li>open creating page</li>
<li>create new computer entity</li>
<li>search new computer by its names</li>
</ul>
</li>
<li><p>save HAR file</p>
</li>
<li><p>using Gatling to generate scala file</p>
</li>
<li><p>execute .&#x2F;gatling.sh</p>
</li>
<li><p><img src="https://user-images.githubusercontent.com/6279298/155529006-2848927d-0b5f-49ca-8e4d-28921972e574.png" alt="see new scala file"></p>
</li>
<li><p>generate test report<br><img src="https://user-images.githubusercontent.com/6279298/155529293-a44863d0-eca7-432f-904f-d774159c4789.png" alt="test report"></p>
</li>
<li><p>so far, you might know how to use gatling to do a simple test.</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/Fdslk/GatlingRepo/blob/main/MyFirstGatlingSimulation">source code</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fdslk.github.io/tech/test/gatling/2023/03/05/gatling-load-test/" data-id="clev2anb4000rj8hs31xmfht4" data-title="gatling_load_test" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-gatling-101" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/tech/test/gatling/2023/03/05/gatling-101/" class="article-date">
  <time class="dt-published" datetime="2023-03-05T07:11:56.000Z" itemprop="datePublished">2023-03-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/tech/">tech</a>►<a class="article-category-link" href="/categories/tech/test/">test</a>►<a class="article-category-link" href="/categories/tech/test/gatling/">gatling</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/tech/test/gatling/2023/03/05/gatling-101/">gatling_101</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Gatling-3-Fundamentals"><a href="#Gatling-3-Fundamentals" class="headerlink" title="Gatling 3 Fundamentals"></a>Gatling 3 Fundamentals</h1><ul>
<li>基本步骤<ul>
<li>创建http client，初始化url，请求头部格式等等<ul>
<li>http.baseUrl</li>
</ul>
</li>
<li>创建测试场景<ul>
<li>scenario 定义测试场景</li>
<li>exec 声明测试的endpoint<ul>
<li>http</li>
<li>get&#x2F;post&#x2F;put ….</li>
<li>check 检查response结果<ul>
<li>eg: check(status.is(200)))</li>
</ul>
</li>
</ul>
</li>
<li>pause 设置等待时间</li>
</ul>
</li>
<li>执行测试<ul>
<li>setUp<ul>
<li>inject 注入<ul>
<li>atOnceUsers 测试并发量</li>
</ul>
</li>
<li>设置http configuration<ul>
<li>protocols</li>
</ul>
</li>
<li>设置测试的并发量</li>
</ul>
</li>
</ul>
</li>
<li>执行测试采用cmd模式<ul>
<li><code>mvn gatling:test -Dgatling.simulationClass=simulations.RunTimeParameters</code></li>
<li>参数前面加上-D表示读取命令行中的参数<ul>
<li>eg: <code>mvn gatling:test -Dgatling.simulationClass=simulations.RunTimeParameters -DUSERS=10 -DRAMP_DURATION=5 -DDURATION=30</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/Fdslk/GatlingRepo/blob/main/gatling3-fundamentals">source code</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fdslk.github.io/tech/test/gatling/2023/03/05/gatling-101/" data-id="clev2anb1000jj8hs32dkatxl" data-title="gatling_101" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-shell-disk-operation" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/tech/shell/2023/03/05/shell-disk-operation/" class="article-date">
  <time class="dt-published" datetime="2023-03-05T07:08:38.000Z" itemprop="datePublished">2023-03-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/tech/">tech</a>►<a class="article-category-link" href="/categories/tech/shell/">shell</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/tech/shell/2023/03/05/shell-disk-operation/">shell_disk_operation</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Disk-operation"><a href="#Disk-operation" class="headerlink" title="Disk operation"></a>Disk operation</h1><ul>
<li>df<ul>
<li><p>展示磁盘的使用情况<br><img src="https://user-images.githubusercontent.com/6279298/162938999-86d33e54-228f-460b-a874-7068d0d030d6.png" alt="disk usage"></p>
</li>
<li><p>du</p>
<ul>
<li>当前目录下的每个文件的使用情况</li>
</ul>
</li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fdslk.github.io/tech/shell/2023/03/05/shell-disk-operation/" data-id="clev2anbd001oj8hsfwzt6u3e" data-title="shell_disk_operation" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-shell-file-operation" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/tech/shell/2023/03/05/shell-file-operation/" class="article-date">
  <time class="dt-published" datetime="2023-03-05T07:08:12.000Z" itemprop="datePublished">2023-03-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/tech/">tech</a>►<a class="article-category-link" href="/categories/tech/shell/">shell</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/tech/shell/2023/03/05/shell-file-operation/">shell_file_operation</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="file-operation"><a href="#file-operation" class="headerlink" title="file operation"></a>file operation</h1><h2 id="definition"><a href="#definition" class="headerlink" title="definition"></a>definition</h2><ul>
<li>什么是Linux的文件系统？</li>
<li>cat<ul>
<li>cat<ul>
<li>-n 对输出的内容加上行号</li>
<li>-b 对输出的内容（除空白行外）都加上行号</li>
<li>&#x2F;dev&#x2F;null &gt; [file name] 清空当前file的内容</li>
</ul>
</li>
</ul>
</li>
<li>chgrp 改变文件或目录的所属群组<ul>
<li><p>-v&#x2F;-c 改变当前文件的群组</p>
<ul>
<li><p>eg：如果想将当前目录下的README文件移动到bin group中</p>
<ul>
<li>chgrp -c bin REMDME.md</li>
<li><img src="https://user-images.githubusercontent.com/6279298/162874839-056be677-25a3-4789-947b-0fc1a96f1865.png" alt="error notification"></li>
<li>查看当前用户的所属的用户组 <code>group</code><br><img src="https://user-images.githubusercontent.com/6279298/162874947-1d422664-7729-45e5-8aa5-9e4603b63419.png" alt="当前用户所属用户组"></li>
<li>运行一下命令将用户添加至指定用户组</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo dseditgroup -o edit -a username -t user groupname</span><br></pre></td></tr></table></figure>

<ul>
<li>使用场景<ul>
<li>用户权限隔离</li>
<li><strong>咋实现的~可以深究一下</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>-R 循环递归处理，将当前目录下的其他的文件采用同样的处理</p>
</li>
</ul>
</li>
<li>chmod <strong>(change mode)</strong><ul>
<li>r - 4, w - 2, x - 1</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th align="left">user</th>
<th align="center">group</th>
<th align="right">other user</th>
</tr>
</thead>
<tbody><tr>
<td align="left">u</td>
<td align="center">g</td>
<td align="right">o</td>
</tr>
</tbody></table>
<ul>
<li><p>chown <strong>(chanage owner)</strong></p>
<ul>
<li>tip: 必须root用户才能执行该命令</li>
</ul>
</li>
<li><p>比较两个文件的不同</p>
</li>
<li><p>diff</p>
<ul>
<li>diff<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">diff README.md ../README.md -y -W 50</span><br></pre></td></tr></table></figure></li>
</ul>
<p><img src="https://user-images.githubusercontent.com/6279298/162893983-ea9da932-b846-4b49-bc1c-e3c22d0caf3c.png" alt="并排比较"></p>
<ul>
<li><p>tips：**|** 表示同行有不同，**&lt;** 后文件比前文件少一行，**&gt;**后文件比前文件多一行</p>
</li>
<li><p>diff file1 file2 | diffstat, 统计两个文件的变化字数</p>
</li>
<li><p>cmp</p>
<ul>
<li>输出两个文件第一处不相同的位置</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="https://user-images.githubusercontent.com/6279298/162893460-62b9b0be-b466-48b0-833a-c02bd7bca2c1.png" alt="diff"></p>
<ul>
<li><p>file: 检索文件类型</p>
<ul>
<li>-b 只输出文件类型，不输出文件名称</li>
<li>-i 输出文件MIME</li>
</ul>
</li>
<li><p>find 查找文件，并执行bash命令</p>
<ul>
<li><p>syntax:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find   path   -option   [   -print ]   [ -exec   -ok   command ]   &#123;&#125; \;</span><br></pre></td></tr></table></figure>
</li>
<li><p>-mindepth 1 -maxdepth 1 指定文件查找深度</p>
</li>
<li><p>应用</p>
<ul>
<li>利用find命令执行多repository的git pull<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . -mindepth 1 -maxdepth 1 -type d -print -exec git -C &#123;&#125; pull \;</span><br></pre></td></tr></table></figure></li>
<li>寻找当前目录下子目录（最小，最大深度为1），文件类型为directory，**{}** 作为find命令的输出目录，**;** 作为 -exec的终结符，**&#x2F;** 作为Semicolon的转义字符</li>
</ul>
</li>
</ul>
</li>
<li><p>ln <strong>(link file)</strong> 使文件和一固定的文件目录建立链接，然后就可以直接使用该文件，避免了文件的拷贝，减少重复的磁盘占用</p>
<ul>
<li><code>ln -s filename link name</code></li>
</ul>
<p><img src="https://user-images.githubusercontent.com/6279298/162903067-a272cf38-8d12-4a4b-84de-bb17677eaa46.png" alt="soft link"></p>
<ul>
<li>怎么实现的??</li>
</ul>
</li>
<li><p>阅读文件</p>
<ul>
<li>less</li>
<li>more（分页读取数据）</li>
</ul>
</li>
<li><p>编辑文件</p>
<ul>
<li>sed 对文件内容做基础的替换 (linux与macOS上有区别)<ul>
<li>linux:<ul>
<li>sed <strong>-i</strong> s’new&#x2F;original’ (将文件内容替换并保存)</li>
<li>sed <strong>-i_bkp</strong> ~ (将文件内容替换并保存，备份)</li>
</ul>
</li>
<li>maxOS<ul>
<li>sed -i “” ~</li>
<li>sed -i “bkp” ~</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>提取字符</p>
<ul>
<li>cut 获取文件中，每一行的某个位置的值</li>
<li>linux<ul>
<li><code>cut -d&#39; &#39; -f1</code></li>
</ul>
</li>
<li>mac<ul>
<li><code>cut -f1 -d &#39; &#39;</code> or <code>cut -d&#39; &#39; -f1</code></li>
</ul>
</li>
</ul>
</li>
<li><p>统计</p>
<ul>
<li>词数 <code>wc -w</code></li>
<li>行数 <code>wc -l</code></li>
<li><strong>tip</strong>: mac中使用wc命令的输出的前面会有很多的空格，所以如果使用管道的传递结果的话，使用单个空格处理的话要注意</li>
</ul>
</li>
<li><p>管道 <strong>|</strong></p>
<ul>
<li>将上一步执行结果的内容作为参数传递给下一步执行</li>
<li>eg: <code>wc -l file|cut -d&#39; &#39; -f1</code>,输出file的行数，然后再对输出结果做cut处理</li>
</ul>
</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fdslk.github.io/tech/shell/2023/03/05/shell-file-operation/" data-id="clev2anbd001pj8hs7grqdn5y" data-title="shell_file_operation" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-ops-log-management" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/tech/ops/log/2023/03/05/ops-log-management/" class="article-date">
  <time class="dt-published" datetime="2023-03-05T07:04:56.000Z" itemprop="datePublished">2023-03-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/tech/">tech</a>►<a class="article-category-link" href="/categories/tech/ops/">ops</a>►<a class="article-category-link" href="/categories/tech/ops/log/">log</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/tech/ops/log/2023/03/05/ops-log-management/">ops_log_management</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="How-to-collect-manage-and-visualize-our-log-data"><a href="#How-to-collect-manage-and-visualize-our-log-data" class="headerlink" title="How to collect, manage and visualize our log data?"></a><strong>How to collect, manage and visualize our log data?</strong></h1><p><em><strong>author: zengqiang fang</strong></em><br><code>log</code>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;<code>ELK</code>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;<code>EFK</code>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; <code>k8s</code></p>
<h2 id="Background"><a href="#Background" class="headerlink" title="Background"></a><strong>Background</strong></h2><p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; During our daily working, application status, the content of http request and response, exception message, etc, which are very useful to us for debugging online issues and monitoring applications. Therefore, it is necessary to collect log data and visualize log records as a chart. In the past, we recorded log information into logs file. Then, we logged to the server to check log information or downloaded log file. According to this way, it is not only very hard to analyze log in real time, but also it is too difficult to search or filter log by key words. Nowadays, more and more services and systems are deployed in k8s clusters. Therefore, it’s no hesitation to find a new way to collect and visualize data. In the article, we will introduce two k8s supported log frameworks, which are <strong>ELK</strong> and <strong>EFK</strong>. <strong>E</strong> has the same meaning for these two frameworks, ElasticSearch engine. <strong>L</strong> means the <strong>logstash</strong>, log agent. <strong>F</strong> is <strong>fluentd</strong>, k8s Nodes level log collecting application. And <strong>K</strong> also points to the same application, Kibana. It is used to visualize log. During the rest of this article, we will have a detailed description about what they are and how to use them.</p>
<h2 id="Logs-management-frameworks"><a href="#Logs-management-frameworks" class="headerlink" title="Logs management frameworks"></a><strong>Logs management frameworks</strong></h2><h3 id="ELK-ElasticSearch-logstash-kibana"><a href="#ELK-ElasticSearch-logstash-kibana" class="headerlink" title="ELK ElasticSearch logstash kibana"></a><strong>ELK ElasticSearch logstash kibana</strong></h3><p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;<strong>ELK</strong> is a framework which is provided by elastic stack organization. This framework can be divided into three parts. The heart, <strong>ElasticSearch</strong> collects data and is also a data searching engine, which can provide and save data. It can be deployed onto k8s cluster and execute scalation automatically. Then, <strong>logstash</strong> is used to format log and send collecting data to ElasticSearch, like a <strong>pipeline</strong>. In the end, <strong>kibana</strong> is used to visualize the data from ElasticSearch. What’s more, a log collecting tool, <strong>beat (Filebeat)</strong> also needs to be set up for a collection application log and send the log to logstash. And the whole workflow can be presented as the Pic1.</p>
<p><img src="https://user-images.githubusercontent.com/6279298/167979333-e95a53ab-c13e-4ceb-bca2-21196a57d3dc.png" alt="Pic1"></p>
<h3 id="EFK-ElasticSearch-fluentd-kibana"><a href="#EFK-ElasticSearch-fluentd-kibana" class="headerlink" title="EFK ElasticSearch fluentd kibana"></a><strong>EFK ElasticSearch fluentd kibana</strong></h3><p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;<strong>EFK</strong> is another log framework and some features are similar to <strong>ELK</strong>. <strong>EFK</strong> includes a log agent, fluentd for collecting log data and sending log data to ElasticSearch. EFK is supported two endpoints which are <strong>Stackdriver Logging for use with Google Cloud Platform</strong> and <strong>ElasticSearch</strong>. Fluentd is a DeamonSet k8s resource which can be deployed into k8s Nodes as a Deamon Pod. This special pods will collect the log of the pods in the same Nodes. Therefore, <strong>EFK</strong> just needs to deploy ElasticSearch Pods, kibana interface Pods, fleuntd DeamonSet.</p>
<h2 id="How-to-use"><a href="#How-to-use" class="headerlink" title="How to use"></a><strong>How to use</strong></h2><h3 id="ELK"><a href="#ELK" class="headerlink" title="ELK"></a><strong>ELK</strong></h3><h4 id="Deploy-ElasticSearch-engine-in-k8s"><a href="#Deploy-ElasticSearch-engine-in-k8s" class="headerlink" title="Deploy ElasticSearch engine in k8s"></a><strong>Deploy ElasticSearch engine in k8s</strong></h4><ul>
<li>add <a target="_blank" rel="noopener" href="https://github.com/Fdslk/ops/blob/main/ELK/es-manual.yaml">es-manual.yaml file</a> which includes k8s deployment configuration and service configuration. Service file is used to expose es-manual pod. Then other services can access to ElasticSearch service freely. If you want to run es deployment in your local machine, you might specify the <strong>“discovery.type”</strong> is equal to <strong>“single-node”</strong>. The default discovery.type for ElasticSearch is <strong>multi-node</strong>. If es was set as a multi-node cluster, it would discover other nodes. Therefore, some discovery configurations need to be set up. Otherwise, you will get the following errors.</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ERROR: [1] bootstrap checks failed</span><br><span class="line">[1]: the default discovery settings are unsuitable for production use; at least one of [discovery.seed_hosts, discovery.seed_providers, cluster.initial_master_nodes] must be configured</span><br><span class="line">ERROR: ElasticSearch did not exit normally - check the logs at /usr/share/ElasticSearch/logs/docker-cluster.log</span><br></pre></td></tr></table></figure>

<ul>
<li><p>When everything of es is set up correctly, you can input <code>curl http://localhost:&lt;expose port&gt;</code> in your iTerms, the following result you will receive:</p>
  <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;es-manual-ccd547885-4czd4&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cluster_name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;docker-cluster&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cluster_uuid&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;WbVh_VIjS42ppWYuGwovog&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;number&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;7.8.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;build_flavor&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;default&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;build_type&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;docker&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;build_hash&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;757314695644ea9a1dc2fecd26d1a43856725e65&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;build_date&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;2020-06-14T19:35:50.234439Z&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;build_snapshot&quot;</span> <span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;lucene_version&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;8.5.1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;minimum_wire_compatibility_version&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;6.8.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;minimum_index_compatibility_version&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;6.0.0-beta1&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;tagline&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;You Know, for Search&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="Deploy-kibana-in-k8s"><a href="#Deploy-kibana-in-k8s" class="headerlink" title="Deploy kibana in k8s"></a><strong>Deploy kibana in k8s</strong></h4><ul>
<li>Add a <a target="_blank" rel="noopener" href="https://github.com/Fdslk/ops/blob/main/ELK/kibana-elk.yaml">kibana deployment manifest</a> including deployment image and service information. Meanwhile, the ElasticSearch exposed url should be added into the k8s container as an environment variable. Like, <strong>ElasticSearch_HOSTS</strong>. After successfully deploying, command <code>curl http://localhost:32184/status</code> can be used to check if kibana is ready or not. What’s more, you also can utilize k8s service name as hostname with target port to communicate with es pods. When kibana runs up, the following pic can be shown after you access to <code>http://localhost:32184</code> on your browse:<br><img src="https://user-images.githubusercontent.com/6279298/168193484-750f822b-fad8-491c-8d64-3125c5190e2c.png" alt="pic2"></li>
</ul>
<h4 id="Deploy-logstash-in-k8s"><a href="#Deploy-logstash-in-k8s" class="headerlink" title="Deploy logstash in k8s"></a><strong>Deploy logstash in k8s</strong></h4><ul>
<li><p>add <a target="_blank" rel="noopener" href="https://github.com/Fdslk/ops/blob/main/ELK/logstash.yaml">logstash k8s manifest file</a> and <a target="_blank" rel="noopener" href="https://github.com/Fdslk/ops/blob/main/ELK/logstash.conf">configuration file</a>. Based on the first file, we can deploy logstash service in k8s cluster. In the second file, we will define the input and output of the data. logstash.config will be defined as a k8s configMap resource. Then deployment will volume the configMap into k8s pod, which can be used by logstash service.</p>
<ul>
<li>input the following command to create ConfigMap<br><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create configmap logstash-config --from-file ./logstash.conf</span><br></pre></td></tr></table></figure></li>
<li>create deployment</li>
<li>after logstash starts up, we can input <code>kubectl logs &lt;pods name&gt; -f</code> for obtaining useful log data.</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[2022-05-13T08:18:20,309][INFO ][logstash.outputs.ElasticSearch][main] Installing ElasticSearch template to _template/logstash</span><br><span class="line">[2022-05-13T08:18:21,040][INFO ][logstash.inputs.beats    ][main] Beats inputs: Starting input listener &#123;:address=&gt;&quot;0.0.0.0:5044&quot;&#125;</span><br><span class="line">[2022-05-13T08:18:21,057][INFO ][logstash.javapipeline    ][main] Pipeline started &#123;&quot;pipeline.id&quot;=&gt;&quot;main&quot;&#125;</span><br><span class="line">[2022-05-13T08:18:21,150][INFO ][logstash.agent           ] Pipelines running &#123;:count=&gt;1, :running_pipelines=&gt;[:main], :non_running_pipelines=&gt;[]&#125;</span><br><span class="line">[2022-05-13T08:18:21,194][INFO ][org.logstash.beats.Server][main][be216883a18a1108d5ceab3d012b51b20564d3e53d37fdaf62f0441690df42ff] Starting server on port: 5044</span><br><span class="line">[2022-05-13T08:18:21,439][INFO ][logstash.agent           ] Successfully started Logstash API endpoint &#123;:port=&gt;9600&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="Deploy-Filebeat-and-Log-generating-application"><a href="#Deploy-Filebeat-and-Log-generating-application" class="headerlink" title="Deploy Filebeat and Log generating application"></a><strong>Deploy Filebeat and Log generating application</strong></h4><ul>
<li><p>In the end, we will deploy the log collector sidercar, Filebeat. It will collect log data from a sharing log file and send the data to the logstash. At first, we need to define <a target="_blank" rel="noopener" href="https://github.com/Fdslk/ops/blob/main/ELK/filebeat.yml">filebeat manifest</a>, which will illustrate where the filebeat reads the log and where the log is sended. You can input the command to create configMaps for filebeat configuration <code>kubectl create configmap file-beat-config --from-file ./filebeat.yml</code>. Then this configuration will be volumed into pods. When you deploy the log generator application and filebeat application. Then logstash will receive log data from being listened port. To check if the log system works normally or not. You can open your browser and input <code>http://localhost:32184/</code>, kibana GUI will represent to you as follows <strong>pic3</strong>. In order to see the log information, a <strong>Index Pattern</strong> needs to be created first.</p>
<ul>
<li>how to create “Index Pattern”<ul>
<li>open kibana dashboard</li>
<li>click stack management</li>
<li>click index pattern</li>
<li>create new index pattern like <strong>filebeat</strong>*, index is defined in the logstash.conf file<br><img src="https://user-images.githubusercontent.com/6279298/168613317-c88bbf58-3af2-4706-8e12-383a321801a5.png" alt="pic3"></li>
</ul>
</li>
</ul>
</li>
<li><p>At here you have learned how to make a ELK log system on your application.</p>
</li>
</ul>
<h3 id="EFK"><a href="#EFK" class="headerlink" title="EFK"></a><strong>EFK</strong></h3><h4 id="Deploy-ElasticSearch"><a href="#Deploy-ElasticSearch" class="headerlink" title="Deploy ElasticSearch"></a><strong>Deploy ElasticSearch</strong></h4><ul>
<li>The same as the former ElasticSearch deployment manifest</li>
</ul>
<h4 id="Deploy-kibana"><a href="#Deploy-kibana" class="headerlink" title="Deploy kibana"></a><strong>Deploy kibana</strong></h4><ul>
<li>The same as the former Kibana deployment manifest</li>
</ul>
<h4 id="Deploy-fluentd"><a href="#Deploy-fluentd" class="headerlink" title="Deploy fluentd"></a><strong>Deploy fluentd</strong></h4><ul>
<li><p>At here, we will define a <a target="_blank" rel="noopener" href="https://github.com/Fdslk/ops/blob/main/ELK/fluentd-manual.yml">DeamonSet manifest to deploy fluentd</a> which deploy a Pods for collecting the Pods log and docker container log. If everything is set up correctly, you will see the following pic after input KQL <code>kubernetes.namespace_name : &quot;default&quot;</code>.<br><img src="https://user-images.githubusercontent.com/6279298/169063264-d1088d57-00b4-4be7-b168-7597dcf4706c.png" alt="pic4"></p>
</li>
<li><p>Here is some information about the resource DaemonSet from <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/workloads/controllers/daemonset/">kubernetes official website</a></p>
<ul>
<li>A DaemonSet ensures that all (or some) Nodes run a copy of a Pod. As nodes are added to the cluster, Pods are added to them. As nodes are removed from the cluster, those Pods are garbage collected. Deleting a DaemonSet will clean up the Pods it created.</li>
</ul>
</li>
</ul>
<h4 id="Deploy-business-service-application"><a href="#Deploy-business-service-application" class="headerlink" title="Deploy business service application"></a><strong>Deploy business service application</strong></h4><ul>
<li>In our daily delivery, we always deploy our application in k8s. Take <a target="_blank" rel="noopener" href="https://github.com/Fdslk/ops/blob/main/ELK/log-application.yaml">log-application.yaml</a> as an example, we use <strong>slf4j.Logger</strong> to print log on the application console. When a request hits the log-application, it will print its stdout on the console, which will be scanned by fluentd and it will send the log data to ElasticSearch. The following picture <strong>pic5</strong> will be represented.<br><img src="https://user-images.githubusercontent.com/6279298/169491169-7d6b4a79-9e18-4116-8be8-03ece9fe25a5.png" alt="pic6"></li>
</ul>
<h2 id="How-difference-between-them"><a href="#How-difference-between-them" class="headerlink" title="How difference between them"></a><strong>How difference between them</strong></h2><ul>
<li><strong>Components</strong><ul>
<li>For this part, it is very obvious that <strong>ELK</strong> is composed of ElasticSearch, Logstash, filebeats and Kibana. However, <strong>EFK</strong> just includes ElasticSearch, fluentd and Kibana.</li>
</ul>
</li>
<li><strong>Mechanism</strong><ul>
<li>In <strong>ELK</strong> framework, the core feature is the logstash used as a log sending agent. Logstash just likes a log transportation center which can re-process the format, filter and enrichment of logs. It’s very memory-consuming. We can’t deploy a logstash into a container with other logging applications. Therefore, filebeat, a lightweight log collector, works as a log agent to send log to logstash.</li>
<li>In <strong>EFK</strong> framework, fluentd is the core feature. fluentd is deployed on k8s cluster as a DeamonSet resource, which can collect the node metrics and log. And it doesn’t need another log transportation agents. Only if fluentd is set with enough permission, the container and nodes log can be collected directly.</li>
</ul>
</li>
<li><strong>log agent performance</strong><ul>
<li>logstash is written by JRuby and runs on JVM.</li>
<li>fluentd is written by CRuby, which consumes less memory than logstash.</li>
</ul>
</li>
<li><strong>Configuration</strong><ul>
<li>logstash<ul>
<li>You can add your own manifest to set up input and output rules, log format, etc.</li>
</ul>
</li>
<li>fluentd<ul>
<li><a target="_blank" rel="noopener" href="https://docs.fluentd.org/deployment/fluentd-ui">fluentd UI browser</a> (Install, uninstall, and upgrade Fluentd plugins)</li>
<li><a target="_blank" rel="noopener" href="https://github.com/fluent/fluentd-kubernetes-daemonset/blob/master/docker-image/v1.14/debian-ElasticSearch7/Dockerfile">Dockerfile</a></li>
</ul>
</li>
</ul>
</li>
<li><strong>Usage scenarios</strong><ul>
<li>For <strong>ELK</strong>, it needs more memory. Therefore, logstash might not be suitable for the low-memory machine. On the other hand, <strong>EFK</strong> just consumes less memory. In my opinion, EFK might have a wide range of applications.</li>
</ul>
</li>
<li>More information<ul>
<li>If you want to get more comparison information, you can take the following references a look.</li>
<li><a target="_blank" rel="noopener" href="https://www.educba.com/fluentd-vs-logstash/?source=leftnav">Difference Between Fluentd vs Logstash</a></li>
<li><a target="_blank" rel="noopener" href="https://platform9.com/blog/kubernetes-logging-comparing-fluentd-vs-logstash/">Kubernetes Logging: Comparing Fluentd vs. Logstash</a></li>
<li><a target="_blank" rel="noopener" href="https://www.loomsystems.com/blog/single-post/2017/01/30/a-comparison-of-fluentd-vs-logstash-log-collector">Fluentd vs. LogStash: A Feature Comparison</a></li>
</ul>
</li>
</ul>
<h2 id="Conclusions"><a href="#Conclusions" class="headerlink" title="Conclusions"></a><strong>Conclusions</strong></h2><p>&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;According to this article, two popular log frameworks, <strong>ELK</strong>&amp;<strong>EFK</strong> are introduced to you. Nowadays, application system is significant to our daily development, production troubleshooting, and product issue back-track for finding root result. What’s more, with the log platform generating, several <strong>advantages</strong> comes up to my mind:</p>
<ul>
<li><strong>log-centralized</strong>, with the above two log frameworks, the log of application, docker container and nodes cluster are gathered into one place. As log centralizes, our debugging becomes more and more easy.</li>
<li><strong>real-time</strong>, log agent, logstash and fluentd will almost send system logs to ES in real-time. Because of their real-time file content and port listening, we can obtain real-time log feedback for online issues troubleshooting.</li>
<li><strong>visualization&amp;analysis</strong>, providing KQL for querying data and drawing charts. Providing lots of categories of charts can help us do some analysis.</li>
<li><strong>open-resource and active communities for supporting unknown issues</strong></li>
</ul>
<p><strong>In the end</strong>, all the manifests are provided in my <a target="_blank" rel="noopener" href="https://github.com/Fdslk/ops/tree/main/ELK">github</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fdslk.github.io/tech/ops/log/2023/03/05/ops-log-management/" data-id="clev2anba001ej8hs5ywshvlx" data-title="ops_log_management" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-ops-vanish" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/tech/ops/cache/2023/03/05/ops-vanish/" class="article-date">
  <time class="dt-published" datetime="2023-03-05T07:04:12.000Z" itemprop="datePublished">2023-03-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/tech/">tech</a>►<a class="article-category-link" href="/categories/tech/ops/">ops</a>►<a class="article-category-link" href="/categories/tech/ops/cache/">cache</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/tech/ops/cache/2023/03/05/ops-vanish/">ops_vanish</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Varnish-using-for-new-fresh"><a href="#Varnish-using-for-new-fresh" class="headerlink" title="Varnish using for new fresh"></a>Varnish using for new fresh</h1><ul>
<li><p><strong>What</strong> is varnish</p>
<ul>
<li>Varnish is a http  cache tool for accelerating http request response.</li>
<li>The configuration language of varnish is named as <strong>VCL</strong>, which can handle the incoming requests<ul>
<li>decide what content you want to server</li>
<li>from where you want to get the content</li>
<li>how the request or response should be altered</li>
<li>beef-sandwich<br><img src="https://user-images.githubusercontent.com/6279298/165006846-8501c3a2-e6ea-43c6-81c1-88416128468c.png" alt="varnish in network"></li>
<li>How does it work<ul>
<li>based on VCL program, it can ‘Which backend has this content, how long time can we cache it, is it accessible for this request, should it be redirected elsewhere and so on’.</li>
<li><strong>VCL</strong> can be compiled into C-program which is complied into a shared lib. <strong>This will happen to varnish loads VCL program.</strong></li>
</ul>
</li>
</ul>
</li>
<li>core features<ul>
<li>caching, using Cache-Control HTTP header</li>
<li>Content Composition</li>
<li>support many different OS platforms</li>
<li>full control of every request</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>How</strong> to install varnish</p>
<ul>
<li><code>brew install varnish</code></li>
<li><code>sudo mv  /usr/local/opt/varnish/sbin/varnishd /usr/local/bin/</code></li>
<li>then varnishd can be executed directly</li>
</ul>
</li>
<li><p><strong>How</strong> to use varnish</p>
<ul>
<li><p>in local</p>
<ul>
<li>add default.vcl file</li>
<li>run the following cmd <code>varnishd -a :6081,HTTP -f default.vcl -F</code><ul>
<li>-a listening port</li>
<li>-f configuration file location</li>
<li>-F run varnish in the front</li>
</ul>
</li>
<li>call the <code>127.0.0.1/api/public</code> for testing</li>
</ul>
</li>
<li><p>by docker</p>
<ul>
<li><p>use docker cmd directly</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm -v $(PWD)/default-docker.vcl:/etc/varnish/default.vcl:ro \  </span><br><span class="line">    --tmpfs /var/lib/varnish/varnishd:exec \</span><br><span class="line">    --name my-varnish-container \</span><br><span class="line">    -p 8081:80 \</span><br><span class="line">    -e VARNISH_SIZE=2G \</span><br><span class="line">    varnish</span><br></pre></td></tr></table></figure>

<ul>
<li>varnish proxy the local machine service, the host of vcl should be set as <strong>“docker.mac.for.localhost”</strong>.</li>
<li>tips:<ul>
<li>varnish port in docker is <strong>80</strong></li>
</ul>
</li>
</ul>
</li>
<li><p>use docker file</p>
<ul>
<li><p>create a docker file</p>
</li>
<li><p>mount the vcl file into your custom image</p>
</li>
<li><p>run your custom image</p>
<figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -it --tmpfs /var/lib/varnish/varnishd:exec -p <span class="number">8081</span>:<span class="number">80</span> local-varnish</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>docker-compose</p>
</li>
</ul>
</li>
<li><p>in local k8s</p>
<ul>
<li>create k8s configMap for mounting default.vcl</li>
</ul>
<p><code>kubectl create configmap varnish-vcl --from-file=default.vcl</code></p>
<ul>
<li>deploy</li>
</ul>
<p><code>kubectl apply -f deployment/deployment.yaml</code></p>
<ul>
<li>call api</li>
</ul>
<p><code>http://localhost:6081/api/public</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;All good. You DO NOT need to be authenticated to call /api/public.&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>validate</p>
<ul>
<li><p>step1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it varnish-proxy-5b4844596c-22hsl -c varnish-for-be -- sh</span><br></pre></td></tr></table></figure>
</li>
<li><p>step2<br><code>run varnishlog</code><br><img src="https://user-images.githubusercontent.com/6279298/165884032-802f7273-aa55-4aee-8109-eff0742a445d.png" alt="request detail"></p>
</li>
</ul>
</li>
<li><p>issue:</p>
<ul>
<li>if not define the <strong>Type</strong> in service yaml, it will use the default value <strong>ClusterIP</strong></li>
<li>Solution: add <strong>type: NodePort</strong> under spec section</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/Fdslk/ops/tree/main/varnish">varnish</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fdslk.github.io/tech/ops/cache/2023/03/05/ops-vanish/" data-id="clev2anbc001lj8hs661u12am" data-title="ops_vanish" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-ops-k8s-secret" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/tech/ops/k8s/secret/2023/03/05/ops-k8s-secret/" class="article-date">
  <time class="dt-published" datetime="2023-03-05T07:03:29.000Z" itemprop="datePublished">2023-03-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/tech/">tech</a>►<a class="article-category-link" href="/categories/tech/ops/">ops</a>►<a class="article-category-link" href="/categories/tech/ops/k8s/">k8s</a>►<a class="article-category-link" href="/categories/tech/ops/k8s/secret/">secret</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/tech/ops/k8s/secret/2023/03/05/ops-k8s-secret/">ops_k8s_secret</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="how-to-use-secret-in-k8s"><a href="#how-to-use-secret-in-k8s" class="headerlink" title="how to use secret in k8s"></a>how to use secret in k8s</h1><ul>
<li>encryption method</li>
</ul>
<table>
<thead>
<tr>
<th align="left">name</th>
<th align="center">Description</th>
<th align="right">Strength</th>
<th align="right">Key Length</th>
</tr>
</thead>
<tbody><tr>
<td align="left">identity default</td>
<td align="center">None</td>
<td align="right">test</td>
<td align="right">test</td>
</tr>
<tr>
<td align="left">secretbox</td>
<td align="center">XSalsa20 and Poly1305</td>
<td align="right">Strong</td>
<td align="right">32 byte</td>
</tr>
<tr>
<td align="left">aesgcm</td>
<td align="center">AES-GCM with </br> random nonce</td>
<td align="right">Must be rotated </br> every 200k writes</td>
<td align="right">16, 24, </br> 32-byte</td>
</tr>
<tr>
<td align="left">aescbc</td>
<td align="center">AES-CBC with </br> PKCS#7 padding</td>
<td align="right">Weak</td>
<td align="right">32-byte</td>
</tr>
<tr>
<td align="left">kms</td>
<td align="center">very complex</td>
<td align="right">Strongest</td>
<td align="right">32 byte</td>
</tr>
</tbody></table>
<ul>
<li>define access resource<ul>
<li>PodSecurityPolicy</li>
<li>RBAC</li>
<li>Authentication</li>
</ul>
</li>
</ul>
<h2 id="how-to-create-secret-resource"><a href="#how-to-create-secret-resource" class="headerlink" title="how to create secret resource"></a>how to create secret resource</h2><ul>
<li>create secret from kubectl command<ul>
<li>from file<ul>
<li>cmds  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret generic db-user-pass \</span><br><span class="line">  --from-file=./username.txt \</span><br><span class="line">  --from-file=./password.txt</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>from command line<ul>
<li> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret generic db-user-pass \</span><br><span class="line">--from-literal=username=devuser \</span><br><span class="line">--from-literal=password=&#x27;S!B\*d$zDsb=&#x27;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li>check secret<ul>
<li><code>kubectl get secret db-user-pass -o jsonpath=&#39;&#123;.data&#125;&#39;</code></li>
</ul>
</li>
<li>encode secretbox<ul>
<li><code>kubectl delete secret &lt;secret name&gt;</code></li>
</ul>
</li>
</ul>
</li>
<li>create secret from configurationgst<ul>
<li>create secret yaml file</li>
<li>run <code>kubectl apply -f &lt;your secert yaml&gt;</code></li>
</ul>
</li>
</ul>
<h2 id="how-to-use"><a href="#how-to-use" class="headerlink" title="how to use"></a>how to use</h2><ul>
<li>There are three main ways for a Pod to use a Secret:<ul>
<li>As files in a volume mounted on one or more of its containers.<ul>
<li>add a pod yaml to access to secret</li>
<li>tips:<ul>
<li>add spec.volumeMount section to save the secrect</li>
<li>add spec.volume to mount secret from pod and the should be <strong>same</strong> as the secretName</li>
<li>use cmd <code>kubectl exec &lt;pod name&gt; -it bash</code>, get into the pods and cd to <strong>&#x2F;etc&#x2F;podsecret</strong><br><img src="https://user-images.githubusercontent.com/6279298/163657055-a34866d1-dcbf-4906-9e1a-0475821185d0.png" alt="mounted secret"></li>
</ul>
</li>
</ul>
</li>
<li>As container environment variable.<ul>
<li>add env section<br><img src="https://user-images.githubusercontent.com/6279298/163657778-d357e775-7bfc-4c12-a9f2-8f5e7d7d5b28.png" alt="get env"></li>
</ul>
</li>
<li>By the kubelet when pulling images for the Pod.</li>
</ul>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/Fdslk/ops/tree/main/k8secret">secret</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fdslk.github.io/tech/ops/k8s/secret/2023/03/05/ops-k8s-secret/" data-id="clev2anbb001hj8hs15upb94g" data-title="ops_k8s_secret" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-ops-helm" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/tech/ops/package/2023/03/05/ops-helm/" class="article-date">
  <time class="dt-published" datetime="2023-03-05T07:01:29.000Z" itemprop="datePublished">2023-03-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/tech/">tech</a>►<a class="article-category-link" href="/categories/tech/ops/">ops</a>►<a class="article-category-link" href="/categories/tech/ops/package/">package</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/tech/ops/package/2023/03/05/ops-helm/">ops_helm</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="helm一种CI-x2F-CD工具"><a href="#helm一种CI-x2F-CD工具" class="headerlink" title="helm一种CI&#x2F;CD工具"></a>helm一种CI&#x2F;CD工具</h1><ul>
<li><p>definition: helm可以被当做是k8s的包管理工具，利用helm可以部署自己的应用程序以及其他依赖服务应用，如redis，mysql等等。</p>
</li>
<li><p>如何在本地的k8s集群中使用helm部署服务</p>
<ul>
<li><p>preparation</p>
<ul>
<li><p>docker-desktop or minikube</p>
</li>
<li><p>brew install helm</p>
</li>
<li><p>using helm version to check it works</p>
</li>
</ul>
</li>
<li><p>helm create <code>&lt;your chart name&gt;</code></p>
</li>
<li><p>create a folder name webdemo</p>
<ul>
<li><p>folder structure</p>
<ul>
<li><p>template&#x2F; 存储一些基本的k8s部署文件</p>
</li>
<li><p>Chart chart包的基本信息</p>
</li>
<li><p>values.yaml 模板信息中的替换信息</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>helm packge <code>&lt;you are chart&gt;</code> 创建部署tgz包</p>
</li>
<li><p>helm install <code>&lt;your server name&gt;</code> <code>&lt;your chart tgz package name&gt;</code></p>
</li>
<li><p>helm list 列出部署成功服务</p>
</li>
</ul>
<p><img src="https://user-images.githubusercontent.com/6279298/156680275-7d2c8297-a7bc-4b3c-8b46-591bb20cac90.png" alt="成功截图"></p>
<ul>
<li><p>helm delete 删除部署以及k8s中的部署</p>
</li>
<li><p>helm get manifest 列出部署chart的k8s manifest文件</p>
</li>
</ul>
<p> <img src="https://user-images.githubusercontent.com/6279298/156680958-0fa1870a-21fe-4c75-9741-fd00e12c0082.png" alt="成功截图"></p>
</li>
<li><p>如何添加自己的application</p>
</li>
<li><p>如何将helm添加到Jenkins</p>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/Fdslk/ops/tree/main/helmDemo">helm</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fdslk.github.io/tech/ops/package/2023/03/05/ops-helm/" data-id="clev2anb9001aj8hshoml7zsf" data-title="ops_helm" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-ops-skaffold" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/tech/ops/CD/2023/03/05/ops-skaffold/" class="article-date">
  <time class="dt-published" datetime="2023-03-05T06:57:57.000Z" itemprop="datePublished">2023-03-05</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/tech/">tech</a>►<a class="article-category-link" href="/categories/tech/ops/">ops</a>►<a class="article-category-link" href="/categories/tech/ops/CD/">CD</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/tech/ops/CD/2023/03/05/ops-skaffold/">ops_skaffold</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="minimal-CI-x2F-CD-工具-skaffold"><a href="#minimal-CI-x2F-CD-工具-skaffold" class="headerlink" title="minimal CI&#x2F;CD 工具 skaffold"></a>minimal CI&#x2F;CD 工具 skaffold</h2><p>&amp;nbsp;</p>
<ul>
<li><p>阅读时长：30min</p>
</li>
<li><p><font color="yellow" size="5"><strong>背景</strong></font><br><br /> &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; 项目上使用了很多的ops工具，但是每一个ops的工具又只使用了一部分的功能。其中Jenkins用来构建我们的pipeline主体框架，打包镜像是采用的<strong>skaffold</strong>中<strong>jib</strong>模式，镜像的推送采用的是jenkinsX，部署又是使用的<strong>helm+argocd</strong>。工具太多，看得人天花乱醉的。让人觉得这个项目很高大上哈哈哈。然后我们不想让这个项目在我们看起来很高大上，所以我们准备一个一个的把这些ops工具来变low（熟悉）。在这篇文章中，我会给大家讲讲如何使用<font color="blue" size="5">skaffold</font>， 因为skaffold的作用远不止只有打包镜像。除了项目中用到的这一个功能，skaffold还能当做一个小型的pipeline。囊括了镜像构建，测试以及部署。</p>
</li>
<li><p><font color="Green" size="5"><strong>Skaffold是什么?</strong></font><br>  Skaffold是一个可以让kubernetes本地应用程序的持续开发更容易的命令行工具，换句话来说Skaffold能够用很便捷的方式在本地k8s集群中很快部署的一类工具。<br>* 利用dockerfile，jib（Maven&amp;Gradle）等工具打包镜像以及推送镜像<br>* 与kubectl或者helm chart集成，在本地k8s集群中部署docker镜像<br>* 利用container-structure-test或者test command测试镜像或者代码<br>* 热更新服务<br>* 端口暴露</p>
<ul>
<li>Skaffold的主要workflow包括代码变动的检查，代码镜像的构建，镜像的测试，镜像的推送以及镜像的部署。是一个可以实现一个最小单元的minimal pipeline，如摘自官网的【图一】所示。</li>
<li>Skaffold是一个基于<strong>golang</strong>开发的<strong>cobra.Command</strong> library的CLI应用工具。使用brew install skaffold安装好之后，skaffold的可执行文件被移动到了系统的 <strong>&#x2F;usr&#x2F;local&#x2F;bin</strong>目录下。<br>  <img src="https://user-images.githubusercontent.com/6279298/160609255-b9b1fe0c-853e-467e-9c17-acd31743e29f.png" alt="【图一】"><p style="text-align:center" > 【图一】 </p></li>
</ul>
</li>
<li><p><font color="pink" size="5"><strong>怎么用？</strong></font><br>  </br> &amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;上面说了这么多的skaffold的介绍，那么这个工具具体怎么用？本文将以<strong>java webflux application</strong>来作为我们的demo。</p>
<ul>
<li>Prerequisite<ul>
<li>统一用<font color="rgb(249,208,148)" size="10">Homebrew</font>的工具<ul>
<li>Java 1.8 <code>brew install java</code></li>
<li>Maven <code>brew install maven</code></li>
<li>Skaffold <code>brew install skaffold</code></li>
<li>Minikube <code>brew install minikube</code></li>
<li>Docker <code>brew install docker</code></li>
</ul>
</li>
<li>kubectl<ul>
<li><code>curl -LO https://storage.googleapis.com/kubernetes-release/release/v1.7.0/bin/darwin/amd64/kubectl</code></li>
<li><code>chmod +x ./kubectl</code></li>
<li><code>sudo mv ./kubectl /usr/local/bin/kubectl</code></li>
</ul>
</li>
<li>Jib (在pom文件中插入一个plugin section)</li>
</ul>
</li>
<li>workflow<ul>
<li><p>Skaffold初始化</p>
<ul>
<li>在当前项目的目录下执行<font style="font-family:courier;" size="4"><em><strong>Skaffold init</strong></em></font>，skaffold会根据项目构建工具来进行打包。因为在pom文件中指定了jib打包，如【图二】所示。当skaffold检测到项目中使用的jib 插件打包项目镜像时，将会出现如【图三】所示的提示。<br>  <img src="https://user-images.githubusercontent.com/6279298/160611958-6d8a5056-5cea-4f8b-91a7-735b2f103068.png" alt="【图二】">  <p style="text-align:center" > 【图二】 </p></li>
</ul>
<p>  <img src="https://user-images.githubusercontent.com/6279298/160623736-9666d566-ddc0-49f1-8c39-5c9f8b4c6905.png" alt="【图三】"><br>  <p style="text-align:center" > 【图三】 </p></p>
<ul>
<li>Tips：    <ul>
<li><p>如果使用skaffold的init命令来初始化manifest，默认会初始化使用kubectl的方式来部署镜像。所以会出现如【图四】所示的错误。处理方式很简单，在当前目录下添加上k8s manifest（最简单就是一个pods.yaml文件，如果需要配置更多，加上对应的deployment，</p>
</li>
<li><p>如果对于k8s manifest没有什么特殊的要求（只需要让当前项目能够在本地的k8s cluster中run起来）</p>
<ul>
<li>生成k8s manifest    <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">            kubectl create deployment my-app --image=my-image --dry-run -o yaml &gt; deployment.yaml</span><br><span class="line">            ```   </span><br><span class="line">            * 在run skaffold init生成对应的skaffold</span><br><span class="line">            service）即可。</span><br><span class="line"></span><br><span class="line">![【图四】](https://user-images.githubusercontent.com/6279298/160624657-094f90bd-6179-455a-948f-77dac043a3ce.png)</span><br><span class="line">    &lt;p style=&quot;text-align:center&quot; &gt; 【图四】 &lt;/p&gt;</span><br><span class="line"></span><br><span class="line">* 构建镜像</span><br><span class="line">    * 运行命令&lt;font style=&quot;font-family:courier;&quot; size=&quot;4&quot;&gt;***skaffold build***&lt;/font&gt;</span><br><span class="line">    * skaffold提供给了多种打包方式，包括Dockerfile，jib maven&amp;gradle，buildpacks，Bazel，Ko，custom script。</span><br><span class="line">    * 当前demo中使用了jib maven的方式打包，只需要在skaffold中指定build的方式如下所示的配置：</span><br><span class="line"></span><br><span class="line">    ```yaml</span><br><span class="line">    build:</span><br><span class="line">        artifacts:</span><br><span class="line">        - image: skaffold-webflux-example</span><br><span class="line">            jib:</span><br><span class="line">            args:</span><br><span class="line">            - -Psync</span><br><span class="line">            sync: </span><br><span class="line">                auto: true</span><br><span class="line">        local: &#123;&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
<li>在运行<font style="font-family:courier;" size="4"><em><strong>docker images</strong></em></font>查看镜像是否，打包成功，如【图五】所示：</li>
</ul>
<p>  <img src="https://user-images.githubusercontent.com/6279298/160626812-97cc9ac5-3200-46d9-9268-797b578a3944.png" alt="【图五】"><br>  <p style="text-align:center" > 【图五】 </p>                  </p>
</li>
<li><p>测试镜像</p>
<ul>
<li>当镜像构建成功之后，运行<font style="font-family:courier;" size="4"><em><strong>skaffold test –images skaffold-webflux-example</strong></em></font>测试镜像是否打包成功，以及使用shell脚本运行unit test或者其他测试内容。</li>
<li>测试的种类<ul>
<li>structureTests（镜像的结构测试，如command测试，fileExist测试，fileContent测试）</li>
<li>Custom （指定测试脚本）</li>
</ul>
</li>
</ul>
</li>
<li><p>部署镜像</p>
<ul>
<li>部署方式的支持<ul>
<li>Kubectl <font color="yellow">*</font> （在demo中采用kubectl apply的方式来部署镜像）<ul>
<li><p>运行命令<font style="font-family:courier;" size="4"><em><strong>Skaffold deploy</strong></em></font>，并在skaffold.yaml中加入如下的配置：</p>
  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">deploy:</span></span><br><span class="line">    <span class="attr">kubectl:</span></span><br><span class="line">        <span class="attr">manifests:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">k8s-web.yaml</span></span><br></pre></td></tr></table></figure></li>
<li><p>使用<em><strong>kubectl get pods</strong></em>，查看节点是否部署成功，如【图六】所示：<br>  <img src="https://user-images.githubusercontent.com/6279298/160628288-7d5d16a0-77e0-47c9-993c-32fa2823fce1.png" alt="【图六】"></p>
</li>
<li><p>使用<em><strong>kubectl port-forward 【pods name】 8080:8080</strong></em>, 运行<code>curl --get http://localhost:8080/hello</code>，查看服务是否能够成功被访问。（部署之后，k8s中的服务的端口并没有被暴露，所以需要操作一下端口映射）。</p>
</li>
</ul>
</li>
<li>Helm</li>
<li>Kustomize</li>
<li>Docker</li>
</ul>
</li>
</ul>
</li>
<li><p>其他功能</p>
<ul>
<li><font style="font-family:courier;" size="4"><em><strong>Clean up</strong></em></font>（清除部署）<ul>
<li>ctrl+C</li>
<li>Skaffold delete</li>
</ul>
</li>
<li><font style="font-family:courier;" size="4"><em><strong>Tagpolicy</strong></em></font>（镜像版本号）<ul>
<li>Git commit的索引号</li>
<li>Sha256编码</li>
<li>环境变量</li>
<li>时间戳</li>
</ul>
</li>
<li><font style="font-family:courier;" size="4"><em><strong>Port forward</strong></em></font> （端口映射)  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">portForward:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">resourceType:</span> <span class="string">deployment</span></span><br><span class="line"><span class="attr">resourceName:</span> <span class="string">skaffold-webflux-example-web</span></span><br><span class="line"><span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">localPort:</span> <span class="number">8080</span>    </span><br></pre></td></tr></table></figure></li>
<li><font style="font-family:courier;" size="4"><em><strong>File sync</strong></em></font>（热部署）<ul>
<li>auto，仅适用于jib，bulidpack的打包模式，加入一下配置  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jib:</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-Psync</span></span><br></pre></td></tr></table></figure></li>
<li>infer</li>
<li>manual</li>
</ul>
</li>
</ul>
</li>
<li><p>完整skaffold yaml manifest</p>
  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">skaffold/v2beta26</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Config</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">rxjavademo</span></span><br><span class="line"><span class="attr">build:</span></span><br><span class="line"><span class="attr">tagPolicy:</span></span><br><span class="line">    <span class="attr">envTemplate:</span></span><br><span class="line">    <span class="attr">template:</span> <span class="string">&quot;<span class="template-variable">&#123;&#123;.FOO&#125;&#125;</span>&quot;</span></span><br><span class="line"><span class="attr">artifacts:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">image:</span> <span class="string">skaffold-webflux-example</span></span><br><span class="line">    <span class="attr">jib:</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-Psync</span></span><br><span class="line">    <span class="attr">sync:</span> </span><br><span class="line">    <span class="attr">auto:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">local:</span> &#123;&#125;</span><br><span class="line">    </span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line"><span class="attr">kubectl:</span></span><br><span class="line">    <span class="attr">manifests:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">k8s-web.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">test:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">image:</span> <span class="string">skaffold-webflux-example</span></span><br><span class="line">    <span class="attr">structureTests:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#x27;./structure-test/*&#x27;</span></span><br><span class="line">    <span class="attr">custom:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">command:</span> <span class="string">./scripts/test.sh</span></span><br><span class="line">        <span class="attr">timeoutSeconds:</span> <span class="number">60</span></span><br><span class="line"></span><br><span class="line"><span class="attr">portForward:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">resourceType:</span> <span class="string">deployment</span></span><br><span class="line"><span class="attr">resourceName:</span> <span class="string">skaffold-webflux-example-web</span></span><br><span class="line"><span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"><span class="attr">localPort:</span> <span class="number">8080</span>    </span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
</li>
<li><p><font color="orange" size="5"><strong>坑！！！</strong></font></p>
<ul>
<li><p><font color="" size="4"><strong>这个是做这个分享中最坑的一个部分！！!</strong></font>根据文档中的介绍，如果是使用jib模式的话，可以采用<code>auto aync</code>的方式。设置之后，并不生效，反而会报错， <code>WARN[0044] Skipping deploy due to sync error: copying files: didn&#39;t sync any files</code></p>
</li>
<li><p>在git上遇见相同的问题<br>  <a target="_blank" rel="noopener" href="https://github.com/GoogleContainerTools/skaffold/issues/4246">Skipping deploy due to sync error: copying files: didn’t sync any files #4246
  </a></p>
</li>
<li><p>当时我使用的版本是<strong>1.35.0</strong>，然后我升级到了最新的版本<code>brew ungrade skaffold</code>，然后deploy镜像，满心欢喜的想着，改变代码，能够热部署。文件确实被显示生效了，但是，application的内容并没有更新。如下所示：<br>  <img src="https://user-images.githubusercontent.com/6279298/160637419-babb88a1-7190-4076-83fa-6e7b36d2f356.gif" alt="not work"></p>
</li>
<li><p>没生效之前采用的部署模式是<strong>skaffold+helm</strong>的模式（为啥没有生效得继续读读源码了23333），我换了一种模式，采用了<strong>skaffold+kubectl</strong>的部署模式。首先在项目的pom文件中添加一个id为sync的Profiles，该依赖的作用是，只要类路径上的文件发生变化，使用<strong>spring-boot-devtools</strong>的应用程序就会<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-boot/docs/current/reference/html/using.html#using.devtools.restart">自动重启</a>，如下所示：</p>
  <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">profiles</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span>&gt;</span>sync<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>然后在skaffold.yaml的<strong>build</strong>的section中加了以下的内容，这样可以为maven传递参数，从而激活profile，让application重新启动</p>
  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">jib:</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-Psync</span></span><br></pre></td></tr></table></figure></li>
<li><p>终于成功了！！！！<br>  <img src="https://user-images.githubusercontent.com/6279298/160638449-ee65fd8b-d833-42b3-a5f6-0ebc0b67e8ae.gif" alt="ok"></p>
</li>
</ul>
</li>
<li><p><font color="RED" size="5"><strong>应用场景</strong></font></p>
<ul>
<li>作为pipeline中的镜像打包和上传工具</li>
<li>本地镜像构建工具</li>
<li>Minimal pipeline</li>
<li>Demo showcase</li>
</ul>
</li>
<li><p><font color="BROWN" size="5"><strong>总结</strong></font></p>
<ul>
<li>Pros<ul>
<li>Skaffold可以让本地的k8s部署变得更简单，只需要配置好对应的manifest</li>
<li>功能可以拆分使用，比较灵活</li>
<li>Skaffold配置内容比较简单</li>
<li>Open-source 工具，有社区力量支持</li>
</ul>
</li>
<li>Cons<ul>
<li>如果要了解更多的内容可能需要一定的学习成本，包括golang的基础，k8s的部署基础。</li>
</ul>
</li>
</ul>
</li>
</ul>
</br>

<ul>
<li><font style="font-family:courier;" size="5" color="yellow">感谢大家看到最后，如果不正确的地方，不吝赐教</font></li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/Fdslk/ops/tree/main/skaffoldDemo">skaffold</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://fdslk.github.io/tech/ops/CD/2023/03/05/ops-skaffold/" data-id="clev2anbb001jj8hs7jht7bqs" data-title="ops_skaffold" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/tech/">tech</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/tech/dotnet-core/">dotnet-core</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tech/java/">java</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/tech/java/design-pattern/">design-pattern</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tech/java/lint/">lint</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tech/java/spring-boot/">spring-boot</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/tech/java/spring-boot/101/">101</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tech/java/spring-boot/auth0/">auth0</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tech/java/spring-boot/jwt/">jwt</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tech/java/spring-boot/starter/">starter</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tech/java/spring-boot/webflux/">webflux</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/tech/java/swagger/">swagger</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/tech/java/swagger/open-api/">open-api</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/tech/kotlin/">kotlin</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/tech/kotlin/101/">101</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tech/kotlin/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tech/kotlin/idea-pulgins/">idea pulgins</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/tech/ops/">ops</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/tech/ops/CD/">CD</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tech/ops/cache/">cache</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tech/ops/k8s/">k8s</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/tech/ops/k8s/secret/">secret</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/tech/ops/log/">log</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tech/ops/package/">package</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/tech/shell/">shell</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tech/test/">test</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/tech/test/gatling/">gatling</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/tech/test/java/">java</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/tech/test/java/es/">es</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/tech/video/">video</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/tech/video/ffmpeg/">ffmpeg</a></li></ul></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/techt/">techt</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/techt/java/">java</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/techt/java/java-feature-option-optional/">java feature option-optional</a></li></ul></li></ul></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/elastic-search-java-test/" rel="tag">elastic search, java, test</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/es/" rel="tag">es</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ffmpeg/" rel="tag">ffmpeg</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ffmpeg-coverting-format/" rel="tag">ffmpeg, coverting format</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ffmpeg-media-server/" rel="tag">ffmpeg, media-server</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java-design-pattern-easy-rule/" rel="tag">java, design-pattern, easy-rule</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java-lint/" rel="tag">java, lint</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java-spring-customer-starter/" rel="tag">java, spring, customer-starter</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java-spring-boot-auth0/" rel="tag">java, spring-boot, auth0</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/elastic-search-java-test/" style="font-size: 10px;">elastic search, java, test</a> <a href="/tags/es/" style="font-size: 10px;">es</a> <a href="/tags/ffmpeg/" style="font-size: 10px;">ffmpeg</a> <a href="/tags/ffmpeg-coverting-format/" style="font-size: 10px;">ffmpeg, coverting format</a> <a href="/tags/ffmpeg-media-server/" style="font-size: 10px;">ffmpeg, media-server</a> <a href="/tags/java-design-pattern-easy-rule/" style="font-size: 10px;">java, design-pattern, easy-rule</a> <a href="/tags/java-lint/" style="font-size: 10px;">java, lint</a> <a href="/tags/java-spring-customer-starter/" style="font-size: 10px;">java, spring, customer-starter</a> <a href="/tags/java-spring-boot-auth0/" style="font-size: 10px;">java, spring-boot, auth0</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">March 2023</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/tech/dotnet-core/2023/03/05/dotnet-core-related/">dotnet_core_related</a>
          </li>
        
          <li>
            <a href="/tech/test/gatling/2023/03/05/gatling-load-test/">gatling_load_test</a>
          </li>
        
          <li>
            <a href="/tech/test/gatling/2023/03/05/gatling-101/">gatling_101</a>
          </li>
        
          <li>
            <a href="/tech/shell/2023/03/05/shell-disk-operation/">shell_disk_operation</a>
          </li>
        
          <li>
            <a href="/tech/shell/2023/03/05/shell-file-operation/">shell_file_operation</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 Zengqiang Fang<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>